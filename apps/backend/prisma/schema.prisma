// Prisma schema for MathSolve AI – Programming Challenge Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String                   @id @default(cuid())
  username          String                   @unique
  email             String                   @unique
  passwordHash      String?                  @map("password_hash")
  profileImage      String?                  @map("profile_image")
  bio               String?
  xp                Int                      @default(0)
  currentRank       String                   @default("Novice") @map("current_rank")
  streakCount       Int                      @default(0) @map("streak_count")
  preferredLanguages String?                 @map("preferred_languages") // JSON string array
  roles             String?                  // JSON string array of roles
  emailVerified     Boolean                  @default(false) @map("email_verified")
  provider          String?
  providerId        String?                  @map("provider_id")
  createdAt         DateTime                 @default(now()) @map("created_at")
  updatedAt         DateTime                 @updatedAt @map("updated_at")
  lastActiveAt      DateTime?                @map("last_active_at")

  // Relations
  challenges        Challenge[]
  submissions       Submission[]
  resources         Resource[]
  discussions       Discussion[]
  achievements      Achievement[]
  ratings           ChallengeRating[] 
  bookmarks         Bookmark[]
  orgMemberships    OrganizationMembership[]
  playlists         Playlist[]

  @@map("users")
}

model Challenge {
  id             String                @id @default(cuid())
  slug           String                @unique
  creatorId      String                @map("creator_id")
  title          String
  prompt         String                // Markdown statement
  difficulty     String                // e.g., WARMUP, EASY, MEDIUM, HARD, LEGENDARY
  category       String                // Primary topic area
  topics         String                // JSON string array of topics/tags
  languages      String                // JSON string array of supported languages
  tags           String                // Legacy field – JSON string array for quick filters
  constraints    String?
  sampleInput    String?               @map("sample_input")
  sampleOutput   String?               @map("sample_output")
  starterCode    String?               @map("starter_code") // JSON map {lang: code}
  solutionOutline String?              @map("solution_outline")
  editorialUrl   String?               @map("editorial_url")
  timeLimitMs    Int                   @default(2000) @map("time_limit_ms")
  memoryLimitKb  Int                   @default(256000) @map("memory_limit_kb")
  qualityScore   Float                 @default(0) @map("quality_score")
  viewCount      Int                   @default(0) @map("view_count")
  attemptCount   Int                   @default(0) @map("attempt_count")
  successRate    Float                 @default(0) @map("success_rate")
  visibility     String                @default("PUBLIC")
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")

  // Relations
  creator        User                  @relation(fields: [creatorId], references: [id])
  submissions    Submission[]
  discussions    Discussion[]
  ratings        ChallengeRating[]
  bookmarks      Bookmark[]
  testCases      TestCase[]
  playlists      PlaylistChallenge[]

  @@index([category])
  @@index([difficulty])
  @@index([creatorId])
  @@map("challenges")
}

model TestCase {
  id            String    @id @default(cuid())
  challengeId   String    @map("challenge_id")
  isSample      Boolean   @default(false) @map("is_sample")
  inputData     String    @map("input_data")
  outputData    String    @map("output_data")
  timeLimitMs   Int?      @map("time_limit_ms")
  memoryLimitKb Int?      @map("memory_limit_kb")
  score         Int       @default(0)
  createdAt     DateTime  @default(now()) @map("created_at")

  challenge     Challenge @relation(fields: [challengeId], references: [id])

  @@index([challengeId])
  @@map("test_cases")
}

model Submission {
  id             String    @id @default(cuid())
  challengeId    String    @map("challenge_id")
  userId         String    @map("user_id")
  language       String
  code           String
  status         String    // PENDING, PASS, FAIL, TLE, MLE, RE
  runtimeMs      Int?      @map("runtime_ms")
  memoryKb       Int?      @map("memory_kb")
  testsPassed    Int?      @map("tests_passed")
  totalTests     Int?      @map("total_tests")
  verdictDetails String?   @map("verdict_details") // JSON string storing per-test results
  hintCount      Int       @default(0) @map("hint_count")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  challenge      Challenge @relation(fields: [challengeId], references: [id])
  user           User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([challengeId])
  @@map("submissions")
}

model Resource {
  id         String    @id @default(cuid())
  title      String
  content    String
  type       String    // tutorial, guide, reference, editorial
  category   String
  difficulty String?
  authorId   String    @map("author_id")
  viewCount  Int       @default(0) @map("view_count")
  rating     Float     @default(0)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  author     User      @relation(fields: [authorId], references: [id])
  bookmarks  Bookmark[]

  @@index([category])
  @@index([authorId])
  @@map("resources")
}

model Discussion {
  id          String      @id @default(cuid())
  challengeId String      @map("challenge_id")
  userId      String      @map("user_id")
  content     String      // Markdown content with optional code blocks
  parentId    String?     @map("parent_id")
  isPinned    Boolean     @default(false) @map("is_pinned")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  challenge   Challenge   @relation(fields: [challengeId], references: [id])
  user        User        @relation(fields: [userId], references: [id])
  parent      Discussion? @relation("DiscussionReplies", fields: [parentId], references: [id])
  replies     Discussion[] @relation("DiscussionReplies")

  @@index([challengeId])
  @@index([userId])
  @@map("discussions")
}

model Achievement {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  type        String
  name        String
  description String?
  earnedAt    DateTime @default(now()) @map("earned_at")

  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("achievements")
}

model Organization {
  id        String                   @id @default(cuid())
  name      String
  slug      String                   @unique
  logoUrl   String?                  @map("logo_url")
  planTier  String                   @map("plan_tier")
  settings  String?                  // JSON blob
  createdAt DateTime                 @default(now()) @map("created_at")
  updatedAt DateTime                 @updatedAt @map("updated_at")

  memberships OrganizationMembership[]
  assignments Assignment[]

  @@map("organizations")
}

model OrganizationMembership {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  userId         String        @map("user_id")
  role           String        @default("MEMBER")
  createdAt      DateTime      @default(now()) @map("created_at")

  organization   Organization  @relation(fields: [organizationId], references: [id])
  user           User          @relation(fields: [userId], references: [id])

  @@unique([organizationId, userId])
  @@index([userId])
  @@map("organization_memberships")
}

model Playlist {
  id          String              @id @default(cuid())
  ownerId     String              @map("owner_id")
  title       String
  description String?
  visibility  String              @default("PRIVATE")
  tags        String?             // JSON string array
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  owner       User                @relation(fields: [ownerId], references: [id])
  challenges  PlaylistChallenge[]
  assignments Assignment[]

  @@map("playlists")
}

model PlaylistChallenge {
  id          String    @id @default(cuid())
  playlistId  String    @map("playlist_id")
  challengeId String    @map("challenge_id")
  order       Int       @default(0)

  playlist    Playlist  @relation(fields: [playlistId], references: [id])
  challenge   Challenge @relation(fields: [challengeId], references: [id])

  @@unique([playlistId, challengeId])
  @@map("playlist_challenges")
}

model Assignment {
  id             String        @id @default(cuid())
  organizationId String        @map("organization_id")
  playlistId     String        @map("playlist_id")
  dueDate        DateTime?
  visibility     String        @default("PRIVATE")
  createdAt      DateTime      @default(now()) @map("created_at")

  organization   Organization  @relation(fields: [organizationId], references: [id])
  playlist       Playlist      @relation(fields: [playlistId], references: [id])

  @@map("assignments")
}

model ChallengeRating {
  challengeId String   @map("challenge_id")
  userId      String   @map("user_id")
  rating      Int
  createdAt   DateTime @default(now()) @map("created_at")

  challenge   Challenge @relation(fields: [challengeId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@id([challengeId, userId])
  @@map("challenge_ratings")
}

model Bookmark {
  id           String     @id @default(cuid())
  userId       String     @map("user_id")
  challengeId  String?    @map("challenge_id")
  resourceId   String?    @map("resource_id")
  createdAt    DateTime   @default(now()) @map("created_at")

  user         User       @relation(fields: [userId], references: [id])
  challenge    Challenge? @relation(fields: [challengeId], references: [id])
  resource     Resource?  @relation(fields: [resourceId], references: [id])

  @@index([userId])
  @@map("bookmarks")
}
